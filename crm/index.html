<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">
        <title>CRM Integration</title>
        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="./css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <a class="navbar-brand" href=".">CRM Integration</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#crm">Интеграция CRM</a></li>
            <li><a href="#_1">Компоненты</a></li>
            <li><a href="#_2">Взаимодействие компонентов</a></li>
            <li><a href="#livetex_3">Получение профиля персоны на стороне клиента LiveTex</a></li>
            <li><a href="#livetex_4">Добавление профиля персоны в LiveTex</a></li>
            <li><a href="#_3">Хеш строка</a></li>
            <li><a href="#_4">Секретный ключ</a></li>
            <li><a href="#livetex_5">Получение информации о персоне оператором LiveTex</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="crm">Интеграция CRM</h1>
<p>Руководство по интеграции профиля персоны внешней системы (напр. CRM) с LiveTex.</p>
<h2 id="_1">Компоненты</h2>
<h3 id="livetex">Компоненты клиента LiveTex</h3>
<ul>
<li>Webserver - Сервер клиента</li>
<li>WebApp - Веб приложение клиента (HTML, JS)</li>
<li>API — API для получения профиля персоны (опционально)</li>
</ul>
<h3 id="livetex-widget">LiveTex Widget</h3>
<ul>
<li>API - <a href="https://livetex.github.io/widgets-api-3-0/">API виджета</a> LiveTex (JavaScript в браузере)</li>
</ul>
<h3 id="livetex-backend">LiveTex backend</h3>
<ul>
<li>WAPI — API для Widget</li>
<li>Person-Service - Сервис профиля персоны</li>
<li>PFS — Сервис доступности фич</li>
</ul>
<h3 id="ows-omniworkspace">OWS (OmniWorkSpace)</h3>
<ul>
<li>App — Рабочее место оператора (пульт)</li>
</ul>
<h2 id="_2">Взаимодействие компонентов</h2>
<h3 id="livetex_1">Добавление профиля персоны от клиента LiveTex</h3>
<p><img alt="VisitorFlow" src="https://www.plantuml.com/plantuml/svg/bLHTQnin47okViMIFDG51mhz8F53uNoDYOr33HVYPqNQNDISfQiakuRI_zwLplQThd5J7np6sfdTcT7Qxbdfcbk-WW9_h54Bl4NdU8bPfKeD0hL7ovWxmDmEDZRRiR4IRMugO-5y4fyNW0jklHAgvjgFkNWkhLbhUGhflwRCrIEz6XFq-_XqqDnQypCjClPWjd2MLugildKGDAAMPt1-bUKV9vViJTrgWIK-56Wt50bXW9XzEW6okZx2lhcxdQSdiwBNQAusU8TRM2fPeWzzhgw_vddAoXRJ8xHM_VM7pvyk--e3CJbPe7L61qjAOAyqwMZZbQUeWt6d90BttZgmL4QhTCcW3GOklaIV8yWYw1Tk_LGE6yeGdhXx-atuMT427vMM4JoGPZM4x-vRxTyHXWklDjnZanl43xWWsgnufRl4b8kLGn3xEsgCn1JtGWxoHq2nDwaqakA0H4sx0udj4tKbcyHO8uCaZO1BELVEeqOx44Pl2a-tWgI1KHbsOqA1L7AlwFeQ0Ejq3zuwBTUrfDEEeKHPstdv5xgAu9SuhPCmRBdhG5ip0kLokvhIFqTfey05LtB0XQ1VVWppG0qxHcyChvbT4xHh920ElRlB6gRSyqh96r8pw4bArphvrfcr2VHaM48xClRVwPmkmhokON-DVMoe_W40" /></p>
<h3 id="livetex_2">Получение информации о профиле персоны из внешней системы оператором LiveTex</h3>
<p><img alt="EmployeeFlow" src="https://www.plantuml.com/plantuml/svg/bP9FQy904CNFtKynwAKz28MYM0-22GO4fQ4fz51w63VJiAYxwUp62gNVlHlJQbQaVnOsa9tVlFTs4hjIkaJ63MJqMf6Mj21hiQ39MXKQ96b7B8GzOFOBYymkCfmJnsPj6Bh9Vfq1KsIdf2fHkmZbgc1JwVm_JNzocQiNlpK5zFL-jMXaDczXKOYbsK5dhhRqG3kuUymwqEqFuYYv5HVbCGPCobAGpi7Z9ptrjNp5zqrl1ltXCEoRJj9PU98IMwCpugsIT59AigE9TuJUU2ymWe9SGkWg9YjGEhL5Hurs_O2U1pq_Wcy8dkBxnRF8AOHFDPiibsitow_EwexhJ2DGDkRDpFyC1QDJHgUeyakKqd_CiBM-WT_xG8rBwT5sZfeuQBT7yKEWS6J1MykfEOTtT8xLid9aFmBZG2GSso-jDVm9" /></p>
<h2 id="livetex_3">Получение профиля персоны на стороне клиента LiveTex</h2>
<p>Возможны следующие сценарии получения профиля персоны со стороны клиента LiveTex:</p>
<ol>
<li>Атрибуты персоны формируются на серверной стороне клиента LiveTex и отдаются в HTML/JS.</li>
<li>Веб приложение клиента (JS) запрашивает профиль персоны у своего API.</li>
</ol>
<h2 id="livetex_4">Добавление профиля персоны в LiveTex</h2>
<ol>
<li>Подписаться на событие Widget <code>CONVERSATION_STARTED</code>.</li>
<li>Вызвать метод <code>setAttributes</code> в обработчике <code>onConversationStarted</code>.</li>
</ol>
<pre><code>const onConversationStarted = (ev) =&gt; {
  const personId = findPersonId(dom) // '550e8400-e29b-41d4-a716-446655440000'
  const attributes = findAttributes(dom) // [{name: 'phone', value: '+79005001234'}]
  const hash = findHash(dom) // 'serverside-generated-hash'

  const onSuccess = (_) =&gt; console.log('success')
  const onFailure = (e) =&gt; console.log(`failure: ${e.message}`)

  LiveTex.addAttributes(personId, attributes, hash, onSuccess, onFailure)
}

const descriptor = LiveTex.addEventListener(
  LiveTex.Event.CONVERSATION_STARTED,
  onConversationStarted
)
</code></pre>

<p>Для добавления атрибутов персоны клиент LiveTex должен передать следующие параметры:</p>
<ul>
<li>id персоны в системе клиента</li>
<li>набор атрибутов вида ключ-значение</li>
<li>хеш строка</li>
</ul>
<h2 id="_3">Хеш строка</h2>
<p>Атрибуты персоны должны быть подписаны секретным ключём на стороне сервера клиента LiveTex.</p>
<p>Пример алгоритма на языке Scala:</p>
<pre><code>/**
  * Create hash string for attributes
  *
  * 1. sort attributes by keys then sort by values
  * 2. concat each key+value pair
  * 3. concat all elements from previous step
  * 4. concat with *secret*
  * 5. create sha256 hash
  *
  * @param attributes Seq of (key, val) tuples
  * @param secret Secret string for account
  * @return
  */
def createHash(attributes: Seq[(String, String)], secret: String): String = {
  val attributeValuesWithSecret = attributes
    .map(x =&gt; x._1 + x._2)
    .sorted
    .mkString
    .concat(secret)

  sha256Hash(attributeValuesWithSecret)
}
</code></pre>

<p>Атрибуты без подписи или с невалидной подписью не передаются в подсистему LiveTex извне.</p>
<h2 id="_4">Секретный ключ</h2>
<p>Секретный ключ (<a href="https://ru.wikipedia.org/wiki/UUID">UUID</a> строка) для подписи атрибутов можно получить в личном кабинете клиента LiveTex.</p>
<h2 id="livetex_5">Получение информации о персоне оператором LiveTex</h2>
<p><img alt="ows-crm-attributes" src="./ows-crm-attributes.png" /></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 0.16.3
Build Date UTC : 2017-10-11 12:00:47
-->
